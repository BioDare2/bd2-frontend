import { ChangeDetectionStrategy, Component, Input, ViewChild } from '@angular/core';
import { timer } from 'rxjs';
import { debounceTime, map, tap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "./tooltip.service";
import * as i2 from "@angular/common";
// [attr.display]="showBack ? undefined : 'none'"
// [style.visibility]="showBack ? undefined :'hidden'"
export class TooltipComponent {
    constructor(tooltip, changeDetector) {
        this.tooltip = tooltip;
        this.changeDetector = changeDetector;
        this.boxMargin = 4;
        this.show = false;
        this.ready = false;
    }
    ngOnInit() {
        this.subscription = this.tooltip.request$.pipe(debounceTime(100)).subscribe(request => this.handleRequest(request));
    }
    ngOnDestroy() {
        if (this.subscription) {
            this.subscription.unsubscribe();
        }
    }
    handleRequest([show, label, point, location]) {
        if (show) {
            this.showTooltip(label, point, location);
        }
        else {
            this.hideTooltip(point, location);
        }
    }
    showTooltip(label, point, location) {
        this.ready = false;
        this.label = this.formatLabel(label);
        this.values = this.formatValues(point);
        this.show = true;
        // change detection not mark as it can be called outside ngzone
        this.changeDetector.detectChanges();
        this.updateTextBBox().subscribe(rect => {
            if (this.show) {
                this.position = this.translateToDataLocation(location, this.textBWidth, this.graphic.workspaceWidth);
                this.ready = true;
            }
            // change detection not mark as it can be called outside ngzone
            // it has to be called again as textobox is determined after the timer so does the new position
            // this.changeDetector.markForCheck();
            this.changeDetector.detectChanges();
        });
    }
    translateToDataLocation(location, textBoxWidth, workspaceWidth) {
        let x = location.x + location.width + 2 * this.boxMargin;
        if ((x + textBoxWidth) >= workspaceWidth) {
            x = location.x - textBoxWidth;
        }
        const y = location.y;
        return `translate(${x}, ${y})`;
    }
    hideTooltip(point, location) {
        this.show = false;
        // this.changeDetector.markForCheck();
        this.changeDetector.detectChanges();
    }
    formatValues(point) {
        return `${this.graphic.domainFormatter(point.x)} : ${this.graphic.valuesFormatter(point.y)}`;
    }
    updateTextBBox() {
        return timer(0).pipe(map(r => this.textBBox()), tap(rect => this.setTextBBox(rect)));
    }
    setTextBBox(rect) {
        this.textBX = rect.x - this.boxMargin;
        this.textBY = rect.y - this.boxMargin;
        this.textBHeight = rect.height + 2 * this.boxMargin;
        this.textBWidth = rect.width + 2 * this.boxMargin;
    }
    textBBox() {
        if (!this.textNode) {
            return { x: 0, y: 0, height: 0, width: 0 };
        }
        return this.textNode.nativeElement.getBBox();
    }
    formatLabel(label) {
        if (!label) {
            return '';
        }
        if (label.length < 40) {
            return label;
        }
        return label.substring(0, 38) + '...';
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TooltipComponent, deps: [{ token: i1.TooltipService }, { token: i0.ChangeDetectorRef }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "16.2.12", type: TooltipComponent, selector: "[bd2hm-tooltip]", inputs: { graphic: "graphic", boxMargin: "boxMargin" }, viewQueries: [{ propertyName: "textNode", first: true, predicate: ["text"], descendants: true }], ngImport: i0, template: `
    <svg:g *ngIf="graphic" class="bd2hm-tooltipBox" [attr.display]="show ? undefined : 'none'" [attr.transform]="position">

      <svg:g [attr.opacity]="ready ? 1 : 0">
        <svg:rect [attr.x]="textBX" [attr.width]="textBWidth" [attr.y]="textBY" [attr.height]="textBHeight"
        ></svg:rect>

        <svg:text #text>
          <tspan x="0">{{label}}</tspan>
          <tspan x="0" dy="1.2em">{{values}}</tspan>
        </svg:text>
      </svg:g>

    </svg:g>
  `, isInline: true, dependencies: [{ kind: "directive", type: i2.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TooltipComponent, decorators: [{
            type: Component,
            args: [{ selector: '[bd2hm-tooltip]', template: `
    <svg:g *ngIf="graphic" class="bd2hm-tooltipBox" [attr.display]="show ? undefined : 'none'" [attr.transform]="position">

      <svg:g [attr.opacity]="ready ? 1 : 0">
        <svg:rect [attr.x]="textBX" [attr.width]="textBWidth" [attr.y]="textBY" [attr.height]="textBHeight"
        ></svg:rect>

        <svg:text #text>
          <tspan x="0">{{label}}</tspan>
          <tspan x="0" dy="1.2em">{{values}}</tspan>
        </svg:text>
      </svg:g>

    </svg:g>
  `, changeDetection: ChangeDetectionStrategy.OnPush }]
        }], ctorParameters: function () { return [{ type: i1.TooltipService }, { type: i0.ChangeDetectorRef }]; }, propDecorators: { graphic: [{
                type: Input
            }], boxMargin: [{
                type: Input
            }], textNode: [{
                type: ViewChild,
                args: ['text']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9vbHRpcC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9iZDItbmd4LWhlYXRtYXAvc3JjL2xpYi9wbG90LWVsZW1lbnRzL3Rvb2x0aXAvdG9vbHRpcC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLHVCQUF1QixFQUFxQixTQUFTLEVBQWMsS0FBSyxFQUFxQixTQUFTLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFFckksT0FBTyxFQUEyQixLQUFLLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFFckQsT0FBTyxFQUFDLFlBQVksRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7Ozs7QUFHdEQsaURBQWlEO0FBQ2pELHNEQUFzRDtBQXNCdEQsTUFBTSxPQUFPLGdCQUFnQjtJQXdCM0IsWUFBb0IsT0FBdUIsRUFBVSxjQUFpQztRQUFsRSxZQUFPLEdBQVAsT0FBTyxDQUFnQjtRQUFVLG1CQUFjLEdBQWQsY0FBYyxDQUFtQjtRQWpCdEYsY0FBUyxHQUFHLENBQUMsQ0FBQztRQUtkLFNBQUksR0FBRyxLQUFLLENBQUM7UUFNYixVQUFLLEdBQUcsS0FBSyxDQUFDO0lBT2QsQ0FBQztJQUVELFFBQVE7UUFFTixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FDNUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUNsQixDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRUQsV0FBVztRQUNULElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNyQixJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO1NBQ2pDO0lBQ0gsQ0FBQztJQUVELGFBQWEsQ0FBQyxDQUFDLElB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LENBQUMsU0FBUyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUNwRCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDcEQsQ0FBQztJQUVELFFBQVE7UUFDTixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNsQixPQUFPLEVBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBWSxDQUFDO1NBQ3JEO1FBQ0QsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUMvQyxDQUFDO0lBRUQsV0FBVyxDQUFDLEtBQWE7UUFDdkIsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUFFLE9BQU8sRUFBRSxDQUFDO1NBQUU7UUFDMUIsSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLEVBQUUsRUFBRTtZQUNyQixPQUFPLEtBQUssQ0FBQztTQUNkO1FBRUQsT0FBTyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUM7SUFDeEMsQ0FBQzsrR0EzSFUsZ0JBQWdCO21HQUFoQixnQkFBZ0IsaU5BbEJqQjs7Ozs7Ozs7Ozs7Ozs7R0FjVDs7NEZBSVUsZ0JBQWdCO2tCQXBCNUIsU0FBUzsrQkFDRSxpQkFBaUIsWUFDakI7Ozs7Ozs7Ozs7Ozs7O0dBY1QsbUJBRWdCLHVCQUF1QixDQUFDLE1BQU07cUlBTS9DLE9BQU87c0JBRE4sS0FBSztnQkFJTixTQUFTO3NCQURSLEtBQUs7Z0JBSU4sUUFBUTtzQkFEUCxTQUFTO3VCQUFDLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NoYW5nZURldGVjdGlvblN0cmF0ZWd5LCBDaGFuZ2VEZXRlY3RvclJlZiwgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBJbnB1dCwgT25EZXN0cm95LCBPbkluaXQsIFZpZXdDaGlsZH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7VG9vbHRpcFNlcnZpY2V9IGZyb20gJy4vdG9vbHRpcC5zZXJ2aWNlJztcclxuaW1wb3J0IHtPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24sIHRpbWVyfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHtHcmFwaGljQ29udGV4dCwgUG9pbnR9IGZyb20gJy4uLy4uL2JkMi1oZWF0bWFwLmRvbSc7XHJcbmltcG9ydCB7ZGVib3VuY2VUaW1lLCBtYXAsIHRhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuXHJcbi8vIFthdHRyLmRpc3BsYXldPVwic2hvd0JhY2sgPyB1bmRlZmluZWQgOiAnbm9uZSdcIlxyXG4vLyBbc3R5bGUudmlzaWJpbGl0eV09XCJzaG93QmFjayA/IHVuZGVmaW5lZCA6J2hpZGRlbidcIlxyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICdbYmQyaG0tdG9vbHRpcF0nLFxyXG4gIHRlbXBsYXRlOiBgXHJcbiAgICA8c3ZnOmcgKm5nSWY9XCJncmFwaGljXCIgY2xhc3M9XCJiZDJobS10b29sdGlwQm94XCIgW2F0dHIuZGlzcGxheV09XCJzaG93ID8gdW5kZWZpbmVkIDogJ25vbmUnXCIgW2F0dHIudHJhbnNmb3JtXT1cInBvc2l0aW9uXCI+XHJcblxyXG4gICAgICA8c3ZnOmcgW2F0dHIub3BhY2l0eV09XCJyZWFkeSA/IDEgOiAwXCI+XHJcbiAgICAgICAgPHN2ZzpyZWN0IFthdHRyLnhdPVwidGV4dEJYXCIgW2F0dHIud2lkdGhdPVwidGV4dEJXaWR0aFwiIFthdHRyLnldPVwidGV4dEJZXCIgW2F0dHIuaGVpZ2h0XT1cInRleHRCSGVpZ2h0XCJcclxuICAgICAgICA+PC9zdmc6cmVjdD5cclxuXHJcbiAgICAgICAgPHN2Zzp0ZXh0ICN0ZXh0PlxyXG4gICAgICAgICAgPHRzcGFuIHg9XCIwXCI+e3tsYWJlbH19PC90c3Bhbj5cclxuICAgICAgICAgIDx0c3BhbiB4PVwiMFwiIGR5PVwiMS4yZW1cIj57e3ZhbHVlc319PC90c3Bhbj5cclxuICAgICAgICA8L3N2Zzp0ZXh0PlxyXG4gICAgICA8L3N2ZzpnPlxyXG5cclxuICAgIDwvc3ZnOmc+XHJcbiAgYCxcclxuICBzdHlsZXM6IFtdLFxyXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBUb29sdGlwQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xyXG5cclxuXHJcbiAgQElucHV0KClcclxuICBncmFwaGljOiBHcmFwaGljQ29udGV4dDtcclxuXHJcbiAgQElucHV0KClcclxuICBib3hNYXJnaW4gPSA0O1xyXG5cclxuICBAVmlld0NoaWxkKCd0ZXh0JylcclxuICB0ZXh0Tm9kZTogRWxlbWVudFJlZjxTVkdHcmFwaGljc0VsZW1lbnQ+O1xyXG5cclxuICBzaG93ID0gZmFsc2U7XHJcbiAgbGFiZWw6IHN0cmluZztcclxuICB2YWx1ZXM6IHN0cmluZztcclxuICBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcclxuICBwb3NpdGlvbjogc3RyaW5nO1xyXG5cclxuICByZWFkeSA9IGZhbHNlO1xyXG4gIHRleHRCWDogbnVtYmVyO1xyXG4gIHRleHRCWTogbnVtYmVyO1xyXG4gIHRleHRCV2lkdGg6IG51bWJlcjtcclxuICB0ZXh0QkhlaWdodDogbnVtYmVyO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHRvb2x0aXA6IFRvb2x0aXBTZXJ2aWNlLCBwcml2YXRlIGNoYW5nZURldGVjdG9yOiBDaGFuZ2VEZXRlY3RvclJlZikge1xyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKTogdm9pZCB7XHJcblxyXG4gICAgdGhpcy5zdWJzY3JpcHRpb24gPSB0aGlzLnRvb2x0aXAucmVxdWVzdCQucGlwZShcclxuICAgICAgZGVib3VuY2VUaW1lKDEwMClcclxuICAgICkuc3Vic2NyaWJlKHJlcXVlc3QgPT4gdGhpcy5oYW5kbGVSZXF1ZXN0KHJlcXVlc3QpKTtcclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMuc3Vic2NyaXB0aW9uKSB7XHJcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBoYW5kbGVSZXF1ZXN0KFtzaG93LCBsYWJlbCwgcG9pbnQsIGxvY2F0aW9uXTogW2Jvb2xlYW4sIHN0cmluZywgUG9pbnQsIFBvaW50XSkge1xyXG4gICAgaWYgKHNob3cpIHtcclxuICAgICAgdGhpcy5zaG93VG9vbHRpcChsYWJlbCwgcG9pbnQsIGxvY2F0aW9uKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuaGlkZVRvb2x0aXAocG9pbnQsIGxvY2F0aW9uKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNob3dUb29sdGlwKGxhYmVsOiBzdHJpbmcsIHBvaW50OiBQb2ludCwgbG9jYXRpb246IFBvaW50KSB7XHJcblxyXG4gICAgdGhpcy5yZWFkeSA9IGZhbHNlO1xyXG4gICAgdGhpcy5sYWJlbCA9IHRoaXMuZm9ybWF0TGFiZWwobGFiZWwpO1xyXG4gICAgdGhpcy52YWx1ZXMgPSB0aGlzLmZvcm1hdFZhbHVlcyhwb2ludCk7XHJcblxyXG4gICAgdGhpcy5zaG93ID0gdHJ1ZTtcclxuICAgIC8vIGNoYW5nZSBkZXRlY3Rpb24gbm90IG1hcmsgYXMgaXQgY2FuIGJlIGNhbGxlZCBvdXRzaWRlIG5nem9uZVxyXG5cclxuICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgdGhpcy51cGRhdGVUZXh0QkJveCgpLnN1YnNjcmliZShcclxuICAgICAgcmVjdCA9PiB7XHJcbiAgICAgICAgaWYgKHRoaXMuc2hvdykge1xyXG4gICAgICAgICAgdGhpcy5wb3NpdGlvbiA9IHRoaXMudHJhbnNsYXRlVG9EYXRhTG9jYXRpb24obG9jYXRpb24sIHRoaXMudGV4dEJXaWR0aCwgdGhpcy5ncmFwaGljLndvcmtzcGFjZVdpZHRoKTtcclxuICAgICAgICAgIHRoaXMucmVhZHkgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBjaGFuZ2UgZGV0ZWN0aW9uIG5vdCBtYXJrIGFzIGl0IGNhbiBiZSBjYWxsZWQgb3V0c2lkZSBuZ3pvbmVcclxuICAgICAgICAvLyBpdCBoYXMgdG8gYmUgY2FsbGVkIGFnYWluIGFzIHRleHRvYm94IGlzIGRldGVybWluZWQgYWZ0ZXIgdGhlIHRpbWVyIHNvIGRvZXMgdGhlIG5ldyBwb3NpdGlvblxyXG4gICAgICAgIC8vIHRoaXMuY2hhbmdlRGV0ZWN0b3IubWFya0ZvckNoZWNrKCk7XHJcbiAgICAgICAgdGhpcy5jaGFuZ2VEZXRlY3Rvci5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgIH1cclxuICAgICk7XHJcblxyXG4gIH1cclxuXHJcbiAgdHJhbnNsYXRlVG9EYXRhTG9jYXRpb24obG9jYXRpb246IFBvaW50LCB0ZXh0Qm94V2lkdGg6IG51bWJlciwgd29ya3NwYWNlV2lkdGg6IG51bWJlcikge1xyXG4gICAgbGV0IHggPSBsb2NhdGlvbi54ICsgbG9jYXRpb24ud2lkdGggKyAyICogdGhpcy5ib3hNYXJnaW47XHJcbiAgICBpZiAoKHggKyB0ZXh0Qm94V2lkdGgpID49IHdvcmtzcGFjZVdpZHRoKSB7XHJcbiAgICAgIHggPSBsb2NhdGlvbi54IC0gdGV4dEJveFdpZHRoO1xyXG4gICAgfVxyXG4gICAgY29uc3QgeSA9IGxvY2F0aW9uLnk7XHJcbiAgICByZXR1cm4gYHRyYW5zbGF0ZSgke3h9LCAke3l9KWA7XHJcbiAgfVxyXG5cclxuICBoaWRlVG9vbHRpcChwb2ludDogUG9pbnQsIGxvY2F0aW9uOiBQb2ludCkge1xyXG4gICAgdGhpcy5zaG93ID0gZmFsc2U7XHJcbiAgICAvLyB0aGlzLmNoYW5nZURldGVjdG9yLm1hcmtGb3JDaGVjaygpO1xyXG4gICAgdGhpcy5jaGFuZ2VEZXRlY3Rvci5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgfVxyXG5cclxuICBmb3JtYXRWYWx1ZXMocG9pbnQ6IFBvaW50KSB7XHJcblxyXG4gICAgcmV0dXJuIGAke3RoaXMuZ3JhcGhpYy5kb21haW5Gb3JtYXR0ZXIocG9pbnQueCl9IDogJHt0aGlzLmdyYXBoaWMudmFsdWVzRm9ybWF0dGVyKHBvaW50LnkpfWA7XHJcbiAgfVxyXG5cclxuXHJcbiAgdXBkYXRlVGV4dEJCb3goKTogT2JzZXJ2YWJsZTxTVkdSZWN0PiB7XHJcblxyXG4gICAgcmV0dXJuIHRpbWVyKDApLnBpcGUoXHJcbiAgICAgIG1hcChyID0+IHRoaXMudGV4dEJCb3goKSksXHJcbiAgICAgIHRhcChyZWN0ID0+IHRoaXMuc2V0VGV4dEJCb3gocmVjdCkpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgc2V0VGV4dEJCb3gocmVjdDogU1ZHUmVjdCkge1xyXG4gICAgdGhpcy50ZXh0QlggPSByZWN0LnggLSB0aGlzLmJveE1hcmdpbjtcclxuICAgIHRoaXMudGV4dEJZID0gcmVjdC55IC0gdGhpcy5ib3hNYXJnaW47XHJcbiAgICB0aGlzLnRleHRCSGVpZ2h0ID0gcmVjdC5oZWlnaHQgKyAyICogdGhpcy5ib3hNYXJnaW47XHJcbiAgICB0aGlzLnRleHRCV2lkdGggPSByZWN0LndpZHRoICsgMiAqIHRoaXMuYm94TWFyZ2luO1xyXG4gIH1cclxuXHJcbiAgdGV4dEJCb3goKTogU1ZHUmVjdCB7XHJcbiAgICBpZiAoIXRoaXMudGV4dE5vZGUpIHtcclxuICAgICAgcmV0dXJuIHt4OiAwLCB5OiAwLCBoZWlnaHQ6IDAsIHdpZHRoOiAwfSBhcyBTVkdSZWN0O1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMudGV4dE5vZGUubmF0aXZlRWxlbWVudC5nZXRCQm94KCk7XHJcbiAgfVxyXG5cclxuICBmb3JtYXRMYWJlbChsYWJlbDogc3RyaW5nKSB7XHJcbiAgICBpZiAoIWxhYmVsKSB7IHJldHVybiAnJzsgfVxyXG4gICAgaWYgKGxhYmVsLmxlbmd0aCA8IDQwKSB7XHJcbiAgICAgIHJldHVybiBsYWJlbDtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbGFiZWwuc3Vic3RyaW5nKDAsIDM4KSArICcuLi4nO1xyXG4gIH1cclxufVxyXG4iXX0=