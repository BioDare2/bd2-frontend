import { PetalNode, PolarPoint } from './polar-plot.dom';
import * as d3 from 'd3';
import { SmartRounder } from './smart-rounding';
const DEF_ERR = 0.6 / 24;
const DEF_WIDTH = 0.6 / 24;
const MIN_WIDTH = 0.1 / 24;
const NEGLIGIBLE_ERROR = 0.5 / 24;
const MAX_ERROR = 0.33; // 8/24
export class PolarDomainUtil {
    dataToPetals(dataGroups, domain, scaleRadius, scaleWidth, errors) {
        if (!dataGroups) {
            return [];
        }
        domain[2] = domain[1] - domain[0];
        return dataGroups.map((g, ix) => this.dataToPetal(g, domain, scaleRadius, scaleWidth, errors ? errors[ix] : null));
    }
    dataToPetal(data, domain, scaleRadius, scaleWidth, error) {
        const node = this.calculatePetalProperties(data, domain, scaleRadius, scaleWidth, error);
        node.polarAngle = this.calculatePolarAngle(node.peak, domain);
        node.petalPath = this.calculatePetalPath(node.peak, node.width, node.radiusScale, domain);
        node.polarCoordinates = this.calculatePolarCoordinate(node.peak, domain);
        // shift back after normalization
        node.peak = node.peak + domain[0];
        node.individuals = this.dataToPolarPoint(data, domain);
        return node;
    }
    dataToPolarPoint(data, domain) {
        const ind = data.map(a => {
            const v = new PolarPoint(this.calculatePolarCoordinate(a, domain), undefined);
            return v;
        });
        return ind;
    }
    calculateCircularMeanAndDev(data, domain) {
        data = data.map(v => this.normalize(v, domain));
        const m = d3.mean(data);
        const std = d3.deviation(data) || 0;
        const rot = domain[2] / 2;
        data = data.map(v => v < rot ? v + domain[2] : v);
        const rotM = d3.mean(data) % domain[2];
        const rotStd = d3.deviation(data) || 0;
        if (rotStd < std) {
            return [rotM, rotStd];
        }
        else {
            return [m, std];
        }
    }
    calculatePetalProperties(data, domain, scaleRadius, scaleWidth, error) {
        const node = new PetalNode();
        const meanStd = this.calculateCircularMeanAndDev(data, domain);
        node.peak = meanStd[0];
        node.roundedPeak = SmartRounder.round(node.peak);
        if ((scaleRadius || scaleWidth) && !error) {
            error = meanStd[1];
        }
        node.width = scaleWidth ? error : DEF_WIDTH * domain[2];
        if (node.width < MIN_WIDTH * domain[2]) {
            node.width = MIN_WIDTH * domain[2];
        }
        if (node.width > domain[2] / 2) {
            node.width = domain[2] / 2;
        }
        node.radiusScale = 1;
        if (scaleRadius) {
            error = error / domain[2];
            error = error <= NEGLIGIBLE_ERROR ? 0 : error;
            error = error > MAX_ERROR ? MAX_ERROR : error;
            node.radiusScale = 1 - 0.5 * error / MAX_ERROR;
        }
        return node;
    }
    calculatePetalPath(peak, width, radiusScale, domain) {
        const path = [
            [0, 0],
            [0.5 * radiusScale, this.calculatePolarAngle(peak - width, domain)],
            [1 * radiusScale, this.calculatePolarAngle(peak, domain)],
            [0.5 * radiusScale, this.calculatePolarAngle(peak + width, domain)],
        ];
        return path;
    }
    normalize(value, domain) {
        value = value - domain[0];
        value = value % domain[2];
        if (value < 0) {
            value += domain[2];
        }
        return value;
    }
    calculatePolarCoordinate(value, domain) {
        value = this.normalize(value, domain);
        return this.normalizedPeakToPolar(value, domain[2]);
    }
    normalizedPeakToPolar(value, range) {
        return [
            Math.cos(value * 2 * Math.PI / range - Math.PI / 2),
            Math.sin(value * 2 * Math.PI / range - Math.PI / 2),
            value
        ];
    }
    calculatePolarAngle(value, domain) {
        value = this.normalize(value, domain);
        return value * 2 * Math.PI / domain[2];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9sYXItZG9tYWluLXV0aWwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9iZDItbmd4LXBvbGFycGxvdC9zcmMvbGliL3BvbGFyLXBsb3QtdXRpbHMvcG9sYXItZG9tYWluLXV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFNBQVMsRUFBRSxVQUFVLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUN2RCxPQUFPLEtBQUssRUFBRSxNQUFNLElBQUksQ0FBQztBQUN6QixPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0sa0JBQWtCLENBQUM7QUFHOUMsTUFBTSxPQUFPLEdBQUcsR0FBRyxHQUFHLEVBQUUsQ0FBQztBQUN6QixNQUFNLFNBQVMsR0FBRyxHQUFHLEdBQUcsRUFBRSxDQUFDO0FBQzNCLE1BQU0sU0FBUyxHQUFHLEdBQUcsR0FBRyxFQUFFLENBQUM7QUFDM0IsTUFBTSxnQkFBZ0IsR0FBRyxHQUFHLEdBQUcsRUFBRSxDQUFDO0FBQ2xDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxDQUFDLE9BQU87QUFFL0IsTUFBTSxPQUFPLGVBQWU7SUFFMUIsWUFBWSxDQUFDLFVBQXNCLEVBQUUsTUFBZ0IsRUFDeEMsV0FBcUIsRUFBRSxVQUFvQixFQUFFLE1BQWlCO1FBRXpFLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDZixPQUFPLEVBQUUsQ0FBQztTQUNYO1FBQ0QsTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFbEMsT0FBTyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxVQUFVLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFB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QUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRCxxQkFBcUIsQ0FBQyxLQUFhLEVBQUUsS0FBYTtRQUNoRCxPQUFPO1lBQ0wsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxFQUFFLEdBQUcsS0FBSyxHQUFHLElBQUksQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ25ELElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsRUFBRSxHQUFHLEtBQUssR0FBRyxJQUFJLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUNuRCxLQUFLO1NBQ04sQ0FBQztJQUNKLENBQUM7SUFFRCxtQkFBbUIsQ0FBQyxLQUFhLEVBQUUsTUFBZ0I7UUFDakQsS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRXRDLE9BQU8sS0FBSyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsRUFBRSxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN6QyxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1BldGFsTm9kZSwgUG9sYXJQb2ludH0gZnJvbSAnLi9wb2xhci1wbG90LmRvbSc7XHJcbmltcG9ydCAqIGFzIGQzIGZyb20gJ2QzJztcclxuaW1wb3J0IHtTbWFydFJvdW5kZXJ9IGZyb20gJy4vc21hcnQtcm91bmRpbmcnO1xyXG5cclxuXHJcbmNvbnN0IERFRl9FUlIgPSAwLjYgLyAyNDtcclxuY29uc3QgREVGX1dJRFRIID0gMC42IC8gMjQ7XHJcbmNvbnN0IE1JTl9XSURUSCA9IDAuMSAvIDI0O1xyXG5jb25zdCBORUdMSUdJQkxFX0VSUk9SID0gMC41IC8gMjQ7XHJcbmNvbnN0IE1BWF9FUlJPUiA9IDAuMzM7IC8vIDgvMjRcclxuXHJcbmV4cG9ydCBjbGFzcyBQb2xhckRvbWFpblV0aWwge1xyXG5cclxuICBkYXRhVG9QZXRhbHMoZGF0YUdyb3VwczogbnVtYmVyW11bXSwgZG9tYWluOiBudW1iZXJbXSxcclxuICAgICAgICAgICAgICAgc2NhbGVSYWRpdXM/OiBib29sZWFuLCBzY2FsZVdpZHRoPzogYm9vbGVhbiwgZXJyb3JzPzogbnVtYmVyW10pOiBQZXRhbE5vZGVbXSB7XHJcblxyXG4gICAgaWYgKCFkYXRhR3JvdXBzKSB7XHJcbiAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuICAgIGRvbWFpblsyXSA9IGRvbWFpblsxXSAtIGRvbWFpblswXTtcclxuXHJcbiAgICByZXR1cm4gZGF0YUdyb3Vwcy5tYXAoKGcsIGl4KSA9PiB0aGlzLmRhdGFUb1BldGFsKGcsIGRvbWFpbiwgc2NhbGVSYWRpdXMsIHNjYWxlV2lkdGgsIGVycm9ycyA/IGVycm9yc1tpeF0gOiBudWxsKSk7XHJcbiAgfVxyXG5cclxuICBkYXRhVG9QZXRhbChkYXRhOiBudW1iZXJbXSwgZG9tYWluOiBudW1iZXJbXSxcclxuICAgICAgICAgICAgICBzY2FsZVJhZGl1cz86IGJvb2xlYW4sIHNjYWxlV2lkdGg/OiBib29sZWFuLCBlcnJvcj86IG51bWJlcik6IFBldGFsTm9kZSB7XHJcblxyXG5cclxuICAgIGNvbnN0IG5vZGUgPSB0aGlzLmNhbGN1bGF0ZVBldGFsUHJvcGVydGllcyhkYXRhLCBkb21haW4sIHNjYWxlUmFkaXVzLCBzY2FsZVdpZHRoLCBlcnJvcik7XHJcbiAgICBub2RlLnBvbGFyQW5nbGUgPSB0aGlzLmNhbGN1bGF0ZVBvbGFyQW5nbGUobm9kZS5wZWFrLCBkb21haW4pO1xyXG4gICAgbm9kZS5wZXRhbFBhdGggPSB0aGlzLmNhbGN1bGF0ZVBldGFsUGF0aChub2RlLnBlYWssIG5vZGUud2lkdGgsIG5vZGUucmFkaXVzU2NhbGUsIGRvbWFpbik7XHJcbiAgICBub2RlLnBvbGFyQ29vcmRpbmF0ZXMgPSB0aGlzLmNhbGN1bGF0ZVBvbGFyQ29vcmRpbmF0ZShub2RlLnBlYWssIGRvbWFpbik7XHJcblxyXG4gICAgLy8gc2hpZnQgYmFjayBhZnRlciBub3JtYWxpemF0aW9uXHJcbiAgICBub2RlLnBlYWsgPSBub2RlLnBlYWsgKyBkb21haW5bMF07XHJcblxyXG4gICAgbm9kZS5pbmRpdmlkdWFscyA9IHRoaXMuZGF0YVRvUG9sYXJQb2ludChkYXRhLCBkb21haW4pO1xyXG4gICAgcmV0dXJuIG5vZGU7XHJcbiAgfVxyXG5cclxuICBkYXRhVG9Qb2xhclBvaW50KGRhdGE6IG51bWJlcltdLCBkb21haW46IG51bWJlcltdKTogUG9sYXJQb2ludFtdIHtcclxuXHJcbiAgICBjb25zdCBpbmQgPSBkYXRhLm1hcChhID0+IHtcclxuICAgICAgY29uc3QgdiA9IG5ldyBQb2xhclBvaW50KHRoaXMuY2FsY3VsYXRlUG9sYXJDb29yZGluYXRlKGEsIGRvbWFpbiksIHVuZGVmaW5lZCk7XHJcbiAgICAgIHJldHVybiB2O1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGluZDtcclxuICB9XHJcblxyXG4gIGNhbGN1bGF0ZUNpcmN1bGFyTWVhbkFuZERldihkYXRhOiBudW1iZXJbXSwgZG9tYWluOiBudW1iZXJbXSkge1xyXG5cclxuICAgIGRhdGEgPSBkYXRhLm1hcCh2ID0+IHRoaXMubm9ybWFsaXplKHYsIGRvbWFpbikpO1xyXG4gICAgY29uc3QgbSA9IGQzLm1lYW4oZGF0YSk7XHJcbiAgICBjb25zdCBzdGQgPSBkMy5kZXZpYXRpb24oZGF0YSkgfHwgMDtcclxuXHJcbiAgICBjb25zdCByb3QgPSBkb21haW5bMl0gLyAyO1xyXG4gICAgZGF0YSA9IGRhdGEubWFwKHYgPT4gdiA8IHJvdCA/IHYgKyBkb21haW5bMl0gOiB2KTtcclxuICAgIGNvbnN0IHJvdE0gPSBkMy5tZWFuKGRhdGEpICUgZG9tYWluWzJdO1xyXG4gICAgY29uc3Qgcm90U3RkID0gZDMuZGV2aWF0aW9uKGRhdGEpIHx8IDA7XHJcblxyXG4gICAgaWYgKHJvdFN0ZCA8IHN0ZCkge1xyXG4gICAgICByZXR1cm4gW3JvdE0sIHJvdFN0ZF07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gW20sIHN0ZF07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjYWxjdWxhdGVQZXRhbFByb3BlcnRpZXMoZGF0YTogbnVtYmVyW10sIGRvbWFpbjogbnVtYmVyW10sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlUmFkaXVzPzogYm9vbGVhbiwgc2NhbGVXaWR0aD86IGJvb2xlYW4sIGVycm9yPzogbnVtYmVyKTogUGV0YWxOb2RlIHtcclxuXHJcbiAgICBjb25zdCBub2RlID0gbmV3IFBldGFsTm9kZSgpO1xyXG5cclxuICAgIGNvbnN0IG1lYW5TdGQgPSB0aGlzLmNhbGN1bGF0ZUNpcmN1bGFyTWVhbkFuZERldihkYXRhLCBkb21haW4pO1xyXG5cclxuICAgIG5vZGUucGVhayA9IG1lYW5TdGRbMF07XHJcbiAgICBub2RlLnJvdW5kZWRQZWFrID0gU21hcnRSb3VuZGVyLnJvdW5kKG5vZGUucGVhayk7XHJcblxyXG4gICAgaWYgKChzY2FsZVJhZGl1cyB8fCBzY2FsZVdpZHRoKSAmJiAhZXJyb3IpIHtcclxuICAgICAgZXJyb3IgPSBtZWFuU3RkWzFdO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBub2RlLndpZHRoID0gc2NhbGVXaWR0aCA/IGVycm9yIDogREVGX1dJRFRIICogZG9tYWluWzJdO1xyXG4gICAgaWYgKG5vZGUud2lkdGggPCBNSU5fV0lEVEggKiBkb21haW5bMl0pIHtcclxuICAgICAgbm9kZS53aWR0aCA9IE1JTl9XSURUSCAqIGRvbWFpblsyXTtcclxuICAgIH1cclxuICAgIGlmIChub2RlLndpZHRoID4gZG9tYWluWzJdIC8gMikge1xyXG4gICAgICBub2RlLndpZHRoID0gZG9tYWluWzJdIC8gMjtcclxuICAgIH1cclxuXHJcbiAgICBub2RlLnJhZGl1c1NjYWxlID0gMTtcclxuICAgIGlmIChzY2FsZVJhZGl1cykge1xyXG4gICAgICBlcnJvciA9IGVycm9yIC8gZG9tYWluWzJdO1xyXG4gICAgICBlcnJvciA9IGVycm9yIDw9IE5FR0xJR0lCTEVfRVJST1IgPyAwIDogZXJyb3I7XHJcbiAgICAgIGVycm9yID0gZXJyb3IgPiBNQVhfRVJST1IgPyBNQVhfRVJST1IgOiBlcnJvcjtcclxuXHJcbiAgICAgIG5vZGUucmFkaXVzU2NhbGUgPSAxIC0gMC41ICogZXJyb3IgLyBNQVhfRVJST1I7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG5vZGU7XHJcbiAgfVxyXG5cclxuXHJcbiAgY2FsY3VsYXRlUGV0YWxQYXRoKHBlYWs6IG51bWJlciwgd2lkdGg6IG51bWJlciwgcmFkaXVzU2NhbGU6IG51bWJlciwgZG9tYWluOiBudW1iZXJbXSk6IG51bWJlcltdW10ge1xyXG5cclxuICAgIGNvbnN0IHBhdGggPSBbXHJcbiAgICAgIFswLCAwXSxcclxuICAgICAgWzAuNSAqIHJhZGl1c1NjYWxlLCB0aGlzLmNhbGN1bGF0ZVBvbGFyQW5nbGUocGVhayAtIHdpZHRoLCBkb21haW4pXSxcclxuICAgICAgWzEgKiByYWRpdXNTY2FsZSwgdGhpcy5jYWxjdWxhdGVQb2xhckFuZ2xlKHBlYWssIGRvbWFpbildLFxyXG4gICAgICBbMC41ICogcmFkaXVzU2NhbGUsIHRoaXMuY2FsY3VsYXRlUG9sYXJBbmdsZShwZWFrICsgd2lkdGgsIGRvbWFpbildLFxyXG4gICAgXTtcclxuICAgIHJldHVybiBwYXRoO1xyXG5cclxuICB9XHJcblxyXG5cclxuICBub3JtYWxpemUodmFsdWU6IG51bWJlciwgZG9tYWluOiBudW1iZXJbXSk6IG51bWJlciB7XHJcbiAgICB2YWx1ZSA9IHZhbHVlIC0gZG9tYWluWzBdO1xyXG4gICAgdmFsdWUgPSB2YWx1ZSAlIGRvbWFpblsyXTtcclxuICAgIGlmICh2YWx1ZSA8IDApIHtcclxuICAgICAgdmFsdWUgKz0gZG9tYWluWzJdO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB2YWx1ZTtcclxuICB9XHJcblxyXG4gIGNhbGN1bGF0ZVBvbGFyQ29vcmRpbmF0ZSh2YWx1ZTogbnVtYmVyLCBkb21haW46IG51bWJlcltdKTogbnVtYmVyW10ge1xyXG4gICAgdmFsdWUgPSB0aGlzLm5vcm1hbGl6ZSh2YWx1ZSwgZG9tYWluKTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5ub3JtYWxpemVkUGVha1RvUG9sYXIodmFsdWUsIGRvbWFpblsyXSk7XHJcbiAgfVxyXG5cclxuICBub3JtYWxpemVkUGVha1RvUG9sYXIodmFsdWU6IG51bWJlciwgcmFuZ2U6IG51bWJlcik6IG51bWJlcltdIHtcclxuICAgIHJldHVybiBbXHJcbiAgICAgIE1hdGguY29zKHZhbHVlICogMiAqIE1hdGguUEkgLyByYW5nZSAtIE1hdGguUEkgLyAyKSxcclxuICAgICAgTWF0aC5zaW4odmFsdWUgKiAyICogTWF0aC5QSSAvIHJhbmdlIC0gTWF0aC5QSSAvIDIpLFxyXG4gICAgICB2YWx1ZVxyXG4gICAgXTtcclxuICB9XHJcblxyXG4gIGNhbGN1bGF0ZVBvbGFyQW5nbGUodmFsdWU6IG51bWJlciwgZG9tYWluOiBudW1iZXJbXSk6IG51bWJlciB7XHJcbiAgICB2YWx1ZSA9IHRoaXMubm9ybWFsaXplKHZhbHVlLCBkb21haW4pO1xyXG5cclxuICAgIHJldHVybiB2YWx1ZSAqIDIgKiBNYXRoLlBJIC8gZG9tYWluWzJdO1xyXG4gIH1cclxufVxyXG4iXX0=